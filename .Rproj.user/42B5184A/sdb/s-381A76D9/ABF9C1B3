{
    "collab_server" : "",
    "contents" : "/*\nWrites studypopulation to the relation study.masterfile\nTODO: this is a slow procedure. Lot of calculations. Use EXPLAIN to find a way to speed things up.\n*/\ndrop schema if exists @target_schema cascade;\nCREATE SCHEMA @target_schema;\n\nWITH condition_start AS (\n    /* Step 1. Per patient, take the date of first occurrence of a diagnosis of AF */\n    SELECT person_id, MIN(condition_start_date) as condition_index\n    FROM @cdm_schema.condition_occurrence\n    -- WHERE condition_concept_id in (313217,4117112,45768480,4232697,44782442,4108832,4119602,4119601,4141360,4232691,4199501,4154290) -- or ancestor_concept_id 313217\n    -- WHERE condition_source_value like 'I48%' -- AF is all ICD10 everything starting with I48\n    WHERE condition_start_date > to_date('19000101','yyyymmdd')\n    GROUP BY person_id\n),\n    /* Step 2. First Riva occurrence within inclusion period */\n    riva_start AS (\n    SELECT person_id, MIN(drug_exposure_start_date) as riva_first_date\n    FROM @cdm_schema.drug_exposure\n    WHERE drug_concept_id in (40241331)-- Rivaroxaban (B01AF01)\n        AND drug_exposure_start_date >= to_date(@study_start_yyyymmdd::varchar,'yyyymmdd') -- After Nov 30, 2011\n        AND drug_exposure_start_date <= to_date(@study_end_yyyymmdd::varchar,'yyyymmdd') -- Before Jan 01 2015\n    GROUP BY person_id\n),\n    /* Step 2. First VKA occurrence within inclusion period */\n    vka_start AS (\n    SELECT person_id, MIN(drug_exposure_start_date) as vka_first_date\n    FROM @cdm_schema.drug_exposure\n    WHERE drug_concept_id in (1310149, 19035344) -- Warfarin and Phenprocoumon (B01AA03, B01AA04)\n        AND drug_exposure_start_date >= to_date(@study_start_yyyymmdd::varchar,'yyyymmdd') -- After Nov 30, 2011\n        AND drug_exposure_start_date <= to_date(@study_end_yyyymmdd::varchar,'yyyymmdd') -- Before Jan 01 2015\n    GROUP BY person_id\n),\n    ages AS (\n    SELECT person_id, MAX(value_as_number) as value_as_number\n    FROM @cdm_schema.measurement\n    WHERE measurement_source_value = 'alder'\n    GROUP BY person_id\n),\n/* Step 3. Study population selection */\n    population AS (\n    SELECT person.person_id, person.year_of_birth, condition_index, riva_first_date, vka_first_date, ages.value_as_number as age,\n            -- Determine which was first, riva or vka. 1 = riva, 0 = vka\n            CASE WHEN riva_first_date < vka_first_date OR vka_first_date IS NULL\n                 THEN 1\n                 ELSE 0\n            END as riva_or_vka,\n\n            CASE WHEN riva_first_date < vka_first_date OR vka_first_date IS NULL\n                 THEN riva_first_date\n                 ELSE vka_first_date\n            END as index_date,\n\n            CASE WHEN riva_first_date = vka_first_date\n                 THEN 1\n                 ELSE 0\n            END as same_day\n            -- riva_first_date - tempindex, vka_first_date - tempindex\n    FROM @cdm_schema.person\n    LEFT JOIN riva_start\n        ON person.person_id = riva_start.person_id\n    LEFT JOIN vka_start\n        ON person.person_id = vka_start.person_id\n    LEFT JOIN condition_start\n        ON person.person_id = condition_start.person_id\n    LEFT JOIN ages\n        ON ages.person_id = person.person_id\n),\n/* Step 4. Get OAC drug history */\n    oac_history as (\n        SELECT population.*, drug_concept_id, drug_exposure_start_date\n        FROM @cdm_schema.drug_exposure\n        JOIN population -- Join here decreases the size of the table\n            ON drug_exposure.person_id = population.person_id\n        WHERE drug_concept_id in (40241331,1310149,19035344,40228152,43013024) -- riva, warfarin, phenprocoumon, dabigatran, apixaban\n),\n/* First oac occurrence (for naive calculation) */\n    first_oac as (\n        SELECT person_id, MIN(drug_exposure_start_date) AS first_oac_date\n        FROM oac_history\n        GROUP BY person_id\n),\n/* Step 5. Switchers to other oac after index date. Only keeps first switch*/\n    switchers as (\n        SELECT A.*, B.drug_concept_id as switchto\n        FROM (\n            SELECT person_id, MIN(drug_exposure_start_date) as switchDate\n            FROM oac_history\n            WHERE drug_exposure_start_date > index_date\n                  -- Not the same drug as index drug\n                  AND NOT ( (drug_concept_id = 40241331 AND riva_or_vka = 1)\n                         OR (drug_concept_id in (1310149,19035344) AND riva_or_vka = 0)\n                          )\n            GROUP BY person_id\n        ) A JOIN oac_history B\n                ON A.person_id = B.person_id AND A.switchDate = B.drug_exposure_start_date\n)\n\nSELECT  population.person_id, population.riva_or_vka, population.index_date,\n        -- Naive\n        CASE WHEN first_oac_date < index_date\n             THEN 0 -- Non-naive: Purchase after index date\n             ELSE 1 -- Naive: Purchase before index date,\n        END as is_naive,\n        -- Switch?\n        switchto,\n        switchDate\nINTO @target_schema.@target_table\nFROM population\nLEFT JOIN first_oac\n  ON first_oac.person_id = population.person_id\nLEFT JOIN switchers\n  ON switchers.person_id = population.person_id\nWHERE\n  /* Actual Study population selection rules. */\n  (riva_first_date IS NOT NULL or vka_first_date IS NOT NULL)\n  AND same_day = 0\n  AND age > 18 AND (2012 - year_of_birth) > 18 -- Older than 18 at start of inclusion period\n  AND (condition_index IS NULL OR condition_index < index_date) -- Missing AF or tempindex before index date\nORDER BY person_id\n;\n",
    "created" : 1468238277237.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3507478229",
    "id" : "ABF9C1B3",
    "lastKnownWriteTime" : 1468238351,
    "last_content_update" : 1468238351179,
    "path" : "~/Documents/OHDSIDeriveVariables/inst/sql/sql_server/createCohort_parameterized.sql",
    "project_path" : "inst/sql/sql_server/createCohort_parameterized.sql",
    "properties" : {
    },
    "relative_order" : 7,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "sql"
}